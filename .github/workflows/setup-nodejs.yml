name: NodeJS Setup and Install Express

on:
  push:
    branches: [ master ]

jobs:
  # Primary setup job ‚Äî other jobs will `need` this one
  setup-node:
    runs-on: my-runners

    steps:
      - name: "Debug: Starting checkout"
        run: echo "üîç Starting checkout step..."

      # Anchor a checkout step so we can reuse it later with '*checkout_step'
      - &checkout_step
        name: Checkout repository
        uses: actions/checkout@v4

      - name: "Debug: Setting up Node.js"
        run: echo "‚öôÔ∏è Setting up Node.js version 22..."

      - name: Setup Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Verify Node & npm versions
        run: |
          echo "üîß Checking Node.js and npm versions..."
          echo "Node version:"
          node -v
          echo "npm version:"
          npm -v

      - name: Install dependencies if present
        run: |
          echo "üì¶ Installing dependencies if present"
          if [ -f package.json ]; then npm ci; else echo "no package.json"; fi

  # SonarQube scan (example) ‚Äî reuses the anchored checkout step
  execute-sonarqube-scan:
    needs: setup-node
    runs-on: my-runners

    steps:
      - *checkout_step

      - name: Execute SonarQube Scan
        run: |
          echo "üîç Starting SonarQube scan..."
          # Add your SonarQube scan commands here
          echo "‚úÖ SonarQube scan completed."

  # Two jobs that run in parallel because they both only need `setup-node`
  parallel-stage-1:
    needs: [setup-node]
    runs-on: my-runners

    steps:
      - *checkout_step
      - name: "Checkout using composite action Locally"
        uses: ./.github/actions/checkout-action
        with:
          ref: 'master'
          repository: 'rahulraj2/helmargocd'
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: "Install NodeJS using composite action Locally"
        uses: ./.github/actions/installation-action
        with:
          node-version: '22'

      - name: Run Parallel Task 1
        run: |
          node scripts/sample-node-script.js foo bar
          echo "üîÑ Running parallel task 1..."
          echo "‚úÖ Parallel task 1 completed."

  parallel-stage-2:
    needs: [setup-node]
    runs-on: my-runners

    steps:
      # - *checkout_step

      - name: Run Parallel Task 2
        run: |
          echo "üîÑ Running parallel task 2..."
          echo "‚úÖ Parallel task 2 completed."

  # --- Example 1: Run local scripts directly (bash, node, pwsh)
  run-local-scripts:
    needs: setup-node
    runs-on: my-runners
    steps:
      - *checkout_step
      - name: "Checkout using composite action Locally"
        uses: ./.github/actions/checkout-action
        with:
          ref: 'master'
          repository: 'rahulraj2/helmargocd'
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: "NodeJS Setup using composite action Locally"
        uses: ./.github/actions/installation-action
        with:
          node-version: '22'
          
      - name: Run bash script (Linux/macOS)
        run: |
          chmod +x scripts/deploy.sh || true
          ./scripts/deploy.sh "arg1" "arg2"

      - name: Run Node script
        run: |
          node scripts/sample-node-script.js foo bar

      # - name: Run PowerShell script (pwsh)
      #   shell: pwsh
      #   run: |
      #     ./scripts/deploy.ps1 -Param 'value-from-workflow'

  # --- Example 2: Use the composite action stored at .github/actions/my-action
  run-composite-action:
    needs: setup-node
    runs-on: my-runners
    steps:
      - *checkout_step
      
      - name: Invoke composite action (local)
        uses: ./.github/actions/my-action
        with:
          node-version: '22'
          script: 'scripts/deploy.sh'

  # --- Example 3: Call the reusable workflow template in .github/workflows/ci-template.yml
  call-reusable-workflow:
    needs: setup-node
    uses: ./.github/workflows/ci-template.yml
    with:
      node-version: '22'
      script: 'scripts/deploy.sh'
